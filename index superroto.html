<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ROMedit - A Javascript HEX Editor - FedeKrum</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <div
            id="dropzone"
            class="border rounded p-1"
            ondragover="handleDragOver(event);"
            ondrop="handleFileSelect(event);"
          >
            <p class="text-center">Drag and drop a ROM file to edit</p>
            <div class="text-center">
              <label for="fileInput" class="btn btn-primary">
                or Select a file</label
              >
              <input
                type="file"
                id="fileInput"
                onchange="handleFileSelect(event);"
                style="display: none"
              />
              <small class="form-text text-muted"
                >file name: <span id="filename"></span> | file size:
                <span id="filelength"></span> bytes
              </small>
              <small class="form-text text-muted"
                >md5:
                <span id="md5"></span>
              </small>
            </div>
          </div>
          <div id="offset-group" class="form-group mt-4" hidden>
            <label for="offset"
              >Offset: (in hex notation, default:<span id="offsetDefault"></span
              >) | current decimal value: <span id="offsetDEC"></span
            ></label>
            <input
              type="text"
              class="form-control"
              id="offset"
              name="offset"
              value="1000"
            />
          </div>
          <div id="csv" class="form-group mt-4" hidden>
            <label for="values"
              >Values: (address,byte : both in hex notation) | changes:
              <span id="changes"></span
            ></label>

            <div class="form-row">
              <div class="col col-3">
                <textarea
                  id="valuesStatus"
                  name="valuesStatus"
                  class="form-control"
                  rows="5"
                  readonly
                ></textarea>
              </div>
              <div class="col col-9">
                <textarea
                  id="values"
                  name="values"
                  class="form-control"
                  rows="5"
                ></textarea>
              </div>
              <div class="col col-10"></div>
            </div>

            <a
              id="download_link"
              download=""
              href="””"
              class="btn btn-primary mt-3"
              hidden
              >Download edited file</a
            >

            <small id="md5HashView" class="form-text text-muted" hidden
              >md5:
              <span id="md5Hash"></span>
            </small>
          </div>
          <pre id="file-content"></pre>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/md5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

    <script>
      var originalFileContent = " ";
      var originalFileName = " ";
      var newFileContent = " ";
      var md5Hash = "";
      var md5FileHash = "";
      var values = "";
      var valuesStatus = "";
      var changes;
      var data;
      var offset = Number("0x" + document.getElementById("offset").value); //decimal
      var fileLength = 0;
      document.getElementById("offsetDEC").innerHTML = offset;
      document.getElementById("offsetDefault").innerHTML =
        document.getElementById("offset").value;

      function handleFileSelect(event) {
        event.stopPropagation();
        event.preventDefault();
        var files = event.target.files || event.dataTransfer.files;
        if (files.length > 0) {
          var file = files[0];
          originalFileName = files[0].name;
          var reader = new FileReader();
          //reader.onload = function (event) {
          //originalFileContent = event.target.result;
          //fileLength = originalFileContent.length;
          //md5FileHash = CryptoJS.MD5(originalFileContent).toString();
          reader.onload = function (event) {
            originalFileContent = new Uint8Array(event.target.result);
            fileLength = originalFileContent.length;
            md5FileHash = md5.arrayBuffer(event.target.result);
            document.getElementById("file-content").innerHTML =
              hexEditorView(originalFileContent);
            document.getElementById("md5").innerHTML = md5FileHash;
            document.getElementById("filename").innerHTML = originalFileName;

            document.getElementById("filelength").innerHTML = fileLength;
            document.getElementById("csv").removeAttribute("hidden");
            document.getElementById("offset-group").removeAttribute("hidden");

            newFileContent = originalFileContent;
            generateNewFile(document.getElementById("values").value); //-----------------
          };
          //reader.readAsText(file);
          reader.readAsArrayBuffer(file);
        }
      }

      function handleDragOver(event) {
        event.preventDefault();
      }

      // function setCharAt(str, index, data, offset = 0) {
      //   if (index - offset > str.length - 1) return str;
      //   return (
      //     str.substring(0, index - offset) +
      //     String.fromCharCode(data) +
      //     str.substring(index - offset + 1)
      //   );
      // }

      function setByteAt(arr, index, data, offset = 0) {
        if (index - offset > arr.length - 1) return arr;
        var newArr = new Uint8Array(arr); // Create a copy
        newArr[index - offset] = data;
        return newArr;
      }

      function generateNewFile(str) {
        // document
        //   .getElementById("download_link")
        //   .setAttribute("hidden", "hidden");

        var csvIndex;
        var csvData;
        //newFileContent = originalFileContent;
        newFileContent = originalFileContent.slice();

        const lines = str.split(/\r?\n/); // Split string into array of lines
        const hexPairRegex = /^[0-9a-fA-F]*(?:[,:;-])[0-9a-fA-F]{1,2}$/; // Regex for hex pairs separated by comma
        console.log("---");
        changes = 0;
        valuesStatus = "";
        var msg;
        for (let i = 0; i < lines.length; i++) {
          msg = "✅";
          valuesStatus = valuesStatus + (i + 1) + " ";
          const line = lines[i].replace(/\s/g, ""); // Remove all whitespace from line

          if (hexPairRegex.test(line)) {
            csvIndex = Number("0x" + line.split(/[,:;-]/)[0]) - offset;
            csvData = Number("0x" + line.split(/[,:;-]/)[1]);
            console.log(newFileContent.length);
            if (csvIndex >= 0 && csvIndex < newFileContent.length) {
              changes++;
              newFileContent = setByteAt(newFileContent, csvIndex, csvData, 0);
              console.log(
                `Line ${
                  i + 1
                } contains a valid hex pair: ${csvIndex}*${csvData}`
              );
            } else {
              msg = "🚫R";
            }
          } else {
            msg = "🚫S";
            if (line == "") {
              msg = "";
            }
          }
          valuesStatus = valuesStatus + msg + "\r";
        }
        document.getElementById("valuesStatus").innerHTML = valuesStatus;

        //md5Hash = CryptoJS.MD5(newFileContent).toString();
        md5Hash = md5.arrayBuffer(newFileContent.buffer);

        document.getElementById("md5Hash").innerHTML = md5Hash;

        if (changes > 0) {
          document.getElementById("download_link").removeAttribute("hidden");
          document.getElementById("md5HashView").removeAttribute("hidden");
        } else {
          document
            .getElementById("download_link")
            .setAttribute("hidden", "hidden");
          document
            .getElementById("md5HashView")
            .setAttribute("hidden", "hidden");
        }

        document.getElementById("changes").innerHTML = changes;
        document.getElementById("file-content").innerHTML =
          hexEditorView(newFileContent);

        // ---------------- DOWNLOAD LINK GENERATOR (BLOB)
        //data = new Blob([newFileContent], { type: "application/octet-stream" });
        data = new Blob([newFileContent.buffer], {
          type: "application/octet-stream",
        });
        url = window.URL.createObjectURL(data);
        document
          .getElementById("download_link")
          .setAttribute("download", originalFileName);
        document.getElementById("download_link").href = url;

        console.log(`Changes: ${changes}`);
      }

      // ---------------- VALUES INPUT EVENT
      document.getElementById("values").oninput = () => {
        generateNewFile(document.getElementById("values").value);
      };

      // ---------------- OFFSET INPUT EVENT
      document.getElementById("offset").oninput = () => {
        offset = Number("0x" + document.getElementById("offset").value);
        if (isNaN(offset)) offset = 0;
        document.getElementById("offsetDEC").innerHTML = offset;
        generateNewFile(document.getElementById("values").value);
        console.log(offset); // Do something
      };

      // ---------------- PARALLEL SCROLL
      document.getElementById("values").addEventListener("scroll", function () {
        document.getElementById("valuesStatus").scrollTop = this.scrollTop;
      });

      function onlyPrintable(str) {
        var result = ".".repeat(str.length);
        characters = "abcdefghijklmnopqrstuvwxyz";
        characters += "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        characters += "0123456789";
        characters += "=/*-+,.;:";
        characters += "<>&";
        characters += "'";
        characters += '"';
        for (let index = 0; index < str.length; index++) {
          if (characters.includes(str[index])) {
            result =
              result.slice(0, index) + str[index] + result.slice(index + 1);
          }
        }
        return result;
      }
      console.log(onlyPrintable("<a\nb }c;"));

      function hexEditorView(str) {
        return str;
      }
    </script>
  </body>
</html>
