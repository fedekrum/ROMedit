<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ROMedit - A Javascript HEX Editor - FedeKrum</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <div
            id="dropzone"
            class="border rounded p-1"
            ondragover="handleDragOver(event);"
            ondrop="handleFileSelect(event);"
          >
            <p class="text-center">Drag and drop a ROM file to edit</p>
            <div class="text-center">
              <label for="fileInput" class="btn btn-primary">
                or Select a file</label
              >
              <input
                type="file"
                id="fileInput"
                onchange="handleFileSelect(event);"
                style="display: none"
              />
              <small class="form-text text-muted"
                >file name: <span id="filename"></span> | file size:
                <span id="filelength"></span> bytes
              </small>
              <small class="form-text text-muted"
                >md5:
                <span id="md5"></span>
              </small>
            </div>
          </div>
          <div id="offset-group" class="form-group mt-4" hidden>
            <label for="offset"
              >Offset: (in hex notation, default:<span id="offsetDefault"></span
              >) | current decimal value: <span id="offsetDEC"></span
            ></label>
            <input
              type="text"
              class="form-control"
              id="offset"
              name="offset"
              value="1000"
            />
          </div>
          <div id="csv" class="form-group mt-4" hidden>
            <label for="values"
              >Values: (address,byte : both in hex notation) | changes:
              <span id="changes"></span
            ></label>

            <div class="form-row">
              <div class="col col-3">
                <textarea
                  id="valuesStatus"
                  name="valuesStatus"
                  class="form-control"
                  rows="5"
                  readonly
                ></textarea>
              </div>
              <div class="col col-9">
                <textarea
                  id="values"
                  name="values"
                  class="form-control"
                  rows="5"
                ></textarea>
              </div>
              <div class="col col-10"></div>
            </div>

            <a
              id="download_link"
              download=""
              href="””"
              class="btn btn-primary mt-3"
              hidden
              >Download edited file</a
            >

            <small id="md5HashView" class="form-text text-muted" hidden
              >md5:
              <span id="md5Hash"></span>
            </small>
          </div>
          <pre id="file-content"></pre>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="generate.js"></script>
    <script>
      var originalFileContent;
      var newFileContent;
      var originalFileName = " ";
      //var fileLength = 0;
      var md5Hash = "";
      var md5NewHash = "";
      var values = "";
      var valuesStatus = "";
      var changes;
      var data;
      var offset = Number("0x" + document.getElementById("offset").value); //decimal

      document.getElementById("offsetDefault").innerHTML =
        document.getElementById("offset").value;
      document.getElementById("offsetDEC").innerHTML = offset;

      function handleDragOver(event) {
        event.stopPropagation();
        event.preventDefault();
        event.dataTransfer.dropEffect = "copy";
      }

      function handleFileSelect(event) {
        event.stopPropagation();
        event.preventDefault();

        let files =
          event.type === "drop" ? event.dataTransfer.files : event.target.files;
        let file = files[0];
        let reader = new FileReader();

        reader.onload = function (event) {
          let arrayBuffer = event.target.result;
          originalFileContent = new Uint8Array(arrayBuffer);
          newFileContent = originalFileContent.slice();

          console.log(originalFileContent);
          console.log(newFileContent);
          //hexview(newFileContent);
          // Update MD5
          md5Hash = md5(newFileContent.buffer);
          document.getElementById("md5").innerHTML = md5Hash;

          // Update filename and filesize
          document.getElementById("filename").innerHTML = file.name;
          document.getElementById("filelength").innerHTML = file.size;
          // Show hidden csv and offset-group
          document.getElementById("csv").removeAttribute("hidden");
          document.getElementById("offset-group").removeAttribute("hidden");
          generateNewFile();
        };
        reader.readAsArrayBuffer(file);
      }

      function hexview(bytes) {
        // Create the hex dump
        let hexDump = "00010203 04050607 08090a0b 0c0d0e0f\n";
        hexDump += "-------- -------- -------- --------\n";
        let hexLine = "";
        let asciiLine = "";
        for (let i = 0; i < bytes.length; i++) {
          // Convert byte to hex
          let byteHex = bytes[i].toString(16).padStart(2, "0");
          hexLine += byteHex;

          // Convert byte to ASCII
          let byteChar = bytes[i];
          let char =
            byteChar >= 0x20 && byteChar <= 0x7e
              ? String.fromCharCode(byteChar)
              : ".";
          asciiLine += char;

          // Add spaces after every 4 bytes
          if ((i + 1) % 4 == 0) {
            hexLine += " ";
          }

          // If last byte or if EOL
          if (i == bytes.length - 1 || (i + 1) % 16 == 0) {
            hexDump +=
              hexLine.padEnd(36, " ") + "| " + asciiLine.padEnd(16, " ") + "\n";
            asciiLine = "";
            hexLine = "";
          }
        }

        // Show the hex and ASCII dumps
        let pre = document.getElementById("file-content");
        pre.textContent = hexDump;
      }

      function setByteAt(indexStr, dataStr) {
        //indexStr = parseInt(indexStr.toString(), 16);
        //dataStr = parseInt(dataStr.toString(), 16);
        if (indexStr - offset > newFileContent.length - 1) return;
        if (indexStr - offset < 0) return;
        newFileContent[indexStr - offset] = dataStr;
      }

      // generate

      // ---------------- VALUES INPUT EVENT
      document.getElementById("values").oninput = () => {
        generateNewFile();
      };

      // ---------------- OFFSET INPUT EVENT
      document.getElementById("offset").oninput = () => {
        offset = Number("0x" + document.getElementById("offset").value);
        if (isNaN(offset)) offset = 0;
        document.getElementById("offsetDEC").innerHTML = offset;
        generateNewFile();
        console.log(offset); // Do something
      };

      // ---------------- PARALLEL SCROLL
      document.getElementById("values").addEventListener("scroll", function () {
        document.getElementById("valuesStatus").scrollTop = this.scrollTop;
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
  </body>
</html>
